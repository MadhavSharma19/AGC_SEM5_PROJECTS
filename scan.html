<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>QR Attendance Scanner</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://unpkg.com/@zxing/browser@latest"></script>
  <style>
    /* ========= Modern Dark Theme ========= */
    :root {
      --bg: #0b132b;
      --card: #1c2541;
      --accent: #5bc0be;
      --text: #e0e0e0;
      --muted: #7a8fa6;
      --success: #16db65;
      --danger: #ef476f;
      --border: rgba(255,255,255,0.08);
      --shadow: rgba(0,0,0,0.35);
    }
    body {
      margin: 0;
      padding: 20px;
      background: var(--bg);
      color: var(--text);
      font-family: 'Inter', system-ui, sans-serif;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    header {
      background: linear-gradient(90deg, var(--accent), #3a506b);
      color: #fff;
      padding: 15px 25px;
      border-radius: 12px;
      box-shadow: 0 4px 20px var(--shadow);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 {
      margin: 0;
      font-size: 1.4rem;
      letter-spacing: 0.5px;
    }
    header a {
      color: #fff;
      text-decoration: underline;
      font-weight: 500;
    }

    h2 {
      text-align: center;
      color: var(--accent);
      font-weight: 600;
      margin-bottom: 0;
    }

    fieldset {
      border: 1px solid var(--border);
      background: var(--card);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 8px 24px var(--shadow);
      backdrop-filter: blur(10px);
      transition: 0.3s;
    }
    fieldset:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 28px rgba(0,0,0,0.5);
    }
    legend {
      padding: 0 10px;
      color: var(--accent);
      font-weight: 600;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 12px;
      margin-top: 8px;
    }

    label {
      font-weight: 500;
    }

    input[type="file"], input[type="date"], select {
      background: #111927;
      border: 1px solid var(--border);
      color: var(--text);
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 0.95rem;
    }

    button {
      border: none;
      padding: 10px 18px;
      border-radius: 8px;
      background: var(--accent);
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      transition: 0.25s ease;
    }
    button:hover {
      background: #72e0dc;
      transform: translateY(-2px);
    }
    button.secondary {
      background: #3a506b;
    }
    button.secondary:hover {
      background: #556d88;
    }

    #video {
      width: 100%;
      max-width: 380px;
      height: 280px;
      border-radius: 12px;
      background: #000;
      border: 2px solid var(--border);
      box-shadow: 0 0 20px rgba(0,0,0,0.4);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      border-radius: 8px;
      overflow: hidden;
    }
    th, td {
      padding: 10px 12px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    th {
      background: #0f1e3a;
      color: var(--accent);
      font-weight: 600;
    }
    tr.present td { background: rgba(22,219,101,0.1); color: var(--success); }
    tr.absent td { background: rgba(239,71,111,0.1); color: var(--danger); }
    .muted { color: var(--muted); font-size: 0.9rem; }

    @media (max-width: 600px) {
      fieldset { padding: 15px; }
      #video { width: 100%; height: 240px; }
      .row { flex-direction: column; align-items: flex-start; }
    }
  </style>
</head>
<body>
  <header>
    <h1>QR Attendance Scanner</h1>
    <a href="makeqr.html">Generate QR</a>
  </header>

  <h2>Smart Attendance Dashboard</h2>

  <fieldset>
    <legend>1) Load Students CSV</legend>
    <div class="row">
      <input id="csvInput" type="file" accept=".csv,text/csv"/>
      <span id="status" class="muted">Header must be: class,student,passkey</span>
    </div>
  </fieldset>

  <fieldset>
    <legend>2) Choose Class & Date</legend>
    <div class="row">
      <label>Class:</label>
      <select id="classSel"></select>
      <label>Date:</label>
      <input id="date" type="date"/>
      <span class="muted">Present: <strong id="count">0 / 0</strong></span>
    </div>
  </fieldset>

  <fieldset>
    <legend>3) Scan QR Codes</legend>
    <div class="row">
      <video id="video" muted playsinline></video>
      <div>
        <button id="start">Start</button>
        <button id="stop" class="secondary">Stop</button>
        <p class="muted">Payload format: {"class":"C1","student":"Name","key":"<15>"}.</p>
        <div id="last" class="muted"></div>
      </div>
    </div>
  </fieldset>

  <fieldset>
    <legend>4) Save Attendance</legend>
    <div class="row">
      <button id="chooseDir">Set Save Folder</button>
      <button id="saveDirect">Save CSV</button>
      <button id="download" class="secondary">Download CSV</button>
      <span id="saveStatus" class="muted"></span>
    </div>
  </fieldset>

  <fieldset>
    <legend>Live Status</legend>
    <table>
      <thead><tr><th>Student</th><th>Passkey</th><th>Status</th></tr></thead>
      <tbody id="tbody"></tbody>
    </table>
  </fieldset>

  <!-- Keep same JS logic -->
  <script>
    // --- Same JavaScript Logic ---
    let roster = [], className = "", present = new Set(), controls = null, dirHandle = null;
    const videoEl = document.getElementById('video');
    const classSel = document.getElementById('classSel');
    const dateInput = document.getElementById('date');
    const tbody = document.getElementById('tbody');
    const statusEl = document.getElementById('status');
    const countEl = document.getElementById('count');
    const lastEl = document.getElementById('last');
    const saveStatus = document.getElementById('saveStatus');
    dateInput.value = new Date().toISOString().slice(0,10);

    document.getElementById('csvInput').addEventListener('change', async e=>{
      const f = e.target.files[0]; if(!f) return;
      parseStudents(await f.text());
    });
    function parseStudents(text){
      const lines = text.trim().split(/\r?\n/);
      if (!lines.length) return;
      const header = lines.shift().toLowerCase();
      if (!(header.includes("class") && header.includes("student") && header.includes("passkey"))) {
        alert("CSV header must be: class,student,passkey");
        return;
      }
      roster = lines.filter(Boolean).map(splitCsv).filter(a=>a.length>=3)
                    .map(a=>({class:a[0], student:a[1], passkey:a[2]}));
      const classes = [...new Set(roster.map(r=>r.class))].sort();
      classSel.innerHTML = classes.map(c=>`<option>${esc(c)}</option>`).join("");
      className = classes[0] || "";
      present = new Set();
      rebuild();
      statusEl.textContent = `Loaded ${roster.length} students`;
    }
    classSel.addEventListener('change', ()=>{
      className = classSel.value;
      present = new Set();
      rebuild();
    });
    document.getElementById('start').addEventListener('click', async ()=>{
      if (!className) { alert("Load CSV and select class"); return; }
      try {
        const { BrowserQRCodeReader } = window.ZXingBrowser;
        const reader = new BrowserQRCodeReader();
        controls = await reader.decodeFromConstraints(
          { audio:false, video:{ facingMode:'environment' } },
          videoEl,
          (res, err, ctrls) => { if (res) onScan(res.getText()); }
        );
        statusEl.textContent = "Scanningâ€¦";
      } catch (e) { console.error(e); statusEl.textContent="Camera error (use https or localhost)"; }
    });
    document.getElementById('stop').addEventListener('click', ()=>{
      if (controls) controls.stop();
      statusEl.textContent = "Stopped";
    });
    function onScan(txt){
      try {
        const o = JSON.parse(txt);
        if (o.class !== className) return;
        const r = roster.find(x=>x.class===o.class && x.passkey===o.key);
        if (!r) return;
        present.add(r.passkey);
        rebuild();
        lastEl.textContent = `Scanned: ${r.student}`;
      } catch(_){}
    }
    document.getElementById('chooseDir').addEventListener('click', async ()=>{
      if (!('showDirectoryPicker' in window)) {
        alert('Direct folder save unsupported. Use Chrome/Edge on localhost/https.');
        return;
      }
      try {
        dirHandle = await window.showDirectoryPicker({ mode: 'readwrite' });
        saveStatus.textContent = 'Folder linked. CSV will be saved here.';
      } catch(e){ saveStatus.textContent = 'Folder selection cancelled.'; }
    });
    document.getElementById('saveDirect').addEventListener('click', async ()=>{
      const date = dateInput.value, cls = classSel.value;
      if (!cls) { alert('Select class'); return; }
      const rows = roster.filter(r=>r.class===cls);
      const csv = buildCsv(date, cls, rows, present);
      const filename = `attendance-${date}.csv`;
      if (dirHandle && 'showDirectoryPicker' in window) {
        try {
          const fileHandle = await dirHandle.getFileHandle(filename, { create: true });
          const writable = await fileHandle.createWritable();
          await writable.write(new Blob([csv], { type: 'text/csv' }));
          await writable.close();
          saveStatus.textContent = `Saved: ${filename}`;
          return;
        } catch(e){ saveStatus.textContent = 'Direct save failed, using download instead.'; }
      }
      downloadCsv(csv, filename);
    });
    document.getElementById('download').addEventListener('click', ()=>{
      const date = dateInput.value, cls = classSel.value;
      if (!cls) { alert('Select class'); return; }
      const rows = roster.filter(r=>r.class===cls);
      const csv = buildCsv(date, cls, rows, present);
      downloadCsv(csv, `attendance-${date}.csv`);
    });
    function downloadCsv(text, filename){
      const blob = new Blob([text], {type:'text/csv'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      a.click();
      URL.revokeObjectURL(a.href);
    }
    function rebuild(){
      const rows = roster.filter(r=>r.class===className);
      tbody.innerHTML = rows.map(r=>{
        const yes = present.has(r.passkey);
        return `<tr class="${yes?'present':'absent'}"><td>${esc(r.student)}</td><td class="muted">${esc(r.passkey)}</td><td>${yes?'Present':'Absent'}</td></tr>`;
      }).join("");
      countEl.textContent = `${present.size} / ${rows.length}`;
    }
    function buildCsv(date, cls, rows, presentSet) {
      let out = 'date,class,student,status\n';
      for (const r of rows) {
        const st = presentSet.has(r.passkey) ? 'Present' : 'Absent';
        out += `${date},${csvEsc(cls)},${csvEsc(r.student)},${csvEsc(st)}\n`;
      }
      return out;
    }
    function splitCsv(line){
      const out=[], re=/(?:^|,)(?:"([^"]*(?:""[^"]*)*)"|([^",]*))/g; let m;
      while ((m=re.exec(line))) out.push((m[1]||m[2]||"").replace(/""/g,'"'));
      return out;
    }
    function csvEsc(s){ return /[",]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s; }
    function esc(s){ return String(s).replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }
  </script>
</body>
</html>
